services:
  mysql:
    image: mysql:8.0
    container_name: welcomer-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_ROOT_HOST=%
    ports:
      - "13306:3306"
    networks:
      - welcomer-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${MYSQL_USER}", "-p${MYSQL_PASSWORD}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: welcomer-app
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs
      - ./docker-application.properties:/app/config/application.properties
    environment:
      # Database configuration
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${MYSQL_DATABASE}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=com.mysql.cj.jdbc.Driver

      # Application configuration
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      - SERVER_PORT=${APP_PORT}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics

      # Disable problematic features for startup
      - SPRING_FLYWAY_ENABLED=false
      - SPRING_CLOUD_COMPATIBILITY_VERIFIER_ENABLED=false
      - spring.cloud.compatibility-verifier.enabled=false

      # Development features
      - SPRING_DEVTOOLS_RESTART_ENABLED=true
      - LOGGING_LEVEL_COM_WELCOMER=DEBUG
      - LOGGING_LEVEL_ROOT=INFO
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SPRING_JPA_SHOW_SQL=true
      - SPRING_JPA_FORMAT_SQL=true

      # JVM options and Spring config location
      - JAVA_OPTS=-Xmx1024m -Xms512m -XX:+UseG1GC
      - SPRING_CONFIG_LOCATION=classpath:/application.properties,file:/app/config/application.properties
    ports:
      - "${APP_PORT}:${APP_PORT}"
      - "5005:5005"  # Debug port
      - "9090:9090"  # gRPC port
    networks:
      - welcomer-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${APP_PORT}/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

networks:
    welcomer-network:
        driver: bridge